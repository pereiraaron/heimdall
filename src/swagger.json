{
  "openapi": "3.0.3",
  "info": {
    "title": "Heimdall API",
    "description": "Multi-tenant authentication and authorization service with password and WebAuthn/passkey support.",
    "version": "1.0.0",
    "license": {
      "name": "MIT"
    }
  },
  "servers": [
    {
      "url": "/api",
      "description": "API base path"
    }
  ],
  "tags": [
    { "name": "Auth", "description": "Password-based authentication" },
    { "name": "Passkey", "description": "WebAuthn/FIDO2 passkey authentication" },
    { "name": "Passkey Management", "description": "Manage registered passkeys" },
    { "name": "Users", "description": "User management (project-scoped)" },
    { "name": "Memberships", "description": "Project membership management" }
  ],
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "JWT access token from login or refresh"
      },
      "ApiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "x-api-key",
        "description": "Project API key"
      }
    },
    "schemas": {
      "Error": {
        "type": "object",
        "properties": {
          "message": { "type": "string" }
        },
        "required": ["message"]
      },
      "LoginRequest": {
        "type": "object",
        "required": ["email", "password"],
        "properties": {
          "email": { "type": "string", "format": "email", "example": "user@example.com" },
          "password": { "type": "string", "example": "securePassword123" }
        }
      },
      "LoginResponse": {
        "type": "object",
        "properties": {
          "message": { "type": "string", "example": "Login successful" },
          "accessToken": { "type": "string" },
          "refreshToken": { "type": "string" },
          "refreshTokenExpiresAt": { "type": "string", "format": "date-time" },
          "user": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "username": { "type": "string" },
              "role": { "type": "string", "enum": ["owner", "admin", "manager", "member"] }
            }
          },
          "passkeySetupRequired": { "type": "boolean", "description": "Present when project passkeyPolicy is 'encouraged' and user has no passkeys" }
        }
      },
      "RegisterRequest": {
        "type": "object",
        "required": ["email", "password"],
        "properties": {
          "email": { "type": "string", "format": "email", "example": "newuser@example.com" },
          "password": { "type": "string", "example": "securePassword123" }
        }
      },
      "RefreshRequest": {
        "type": "object",
        "required": ["refreshToken"],
        "properties": {
          "refreshToken": { "type": "string" }
        }
      },
      "RefreshResponse": {
        "type": "object",
        "properties": {
          "accessToken": { "type": "string" },
          "refreshToken": { "type": "string" },
          "refreshTokenExpiresAt": { "type": "string", "format": "date-time" }
        }
      },
      "LogoutRequest": {
        "type": "object",
        "required": ["refreshToken"],
        "properties": {
          "refreshToken": { "type": "string" }
        }
      },
      "PasskeyRegistrationOptionsResponse": {
        "type": "object",
        "properties": {
          "options": {
            "type": "object",
            "description": "WebAuthn PublicKeyCredentialCreationOptions"
          },
          "challengeId": { "type": "string", "description": "Challenge ID to pass back during verification" }
        }
      },
      "PasskeyVerifyRegistrationRequest": {
        "type": "object",
        "required": ["challengeId", "credential"],
        "properties": {
          "challengeId": { "type": "string" },
          "credential": { "type": "object", "description": "WebAuthn credential response from navigator.credentials.create()" },
          "name": { "type": "string", "description": "Optional friendly name for the passkey", "example": "Work Laptop" }
        }
      },
      "PasskeyVerifyRegistrationResponse": {
        "type": "object",
        "properties": {
          "message": { "type": "string", "example": "Passkey registered successfully" },
          "credential": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "name": { "type": "string" },
              "deviceType": { "type": "string" },
              "backedUp": { "type": "boolean" }
            }
          }
        }
      },
      "PasskeyLoginOptionsRequest": {
        "type": "object",
        "properties": {
          "email": { "type": "string", "format": "email", "description": "Optional. Scopes allowed credentials to this user's passkeys." }
        }
      },
      "PasskeyLoginOptionsResponse": {
        "type": "object",
        "properties": {
          "options": {
            "type": "object",
            "description": "WebAuthn PublicKeyCredentialRequestOptions"
          },
          "challengeId": { "type": "string" }
        }
      },
      "PasskeyVerifyLoginRequest": {
        "type": "object",
        "required": ["challengeId", "credential"],
        "properties": {
          "challengeId": { "type": "string" },
          "credential": { "type": "object", "description": "WebAuthn credential response from navigator.credentials.get()" }
        }
      },
      "PasskeyCredential": {
        "type": "object",
        "properties": {
          "name": { "type": "string", "example": "Work Laptop" },
          "deviceType": { "type": "string", "example": "singleDevice" },
          "backedUp": { "type": "boolean" },
          "createdAt": { "type": "string", "format": "date-time" }
        }
      },
      "User": {
        "type": "object",
        "properties": {
          "_id": { "type": "string" },
          "email": { "type": "string", "format": "email" },
          "username": { "type": "string" },
          "role": { "type": "string", "enum": ["owner", "admin", "manager", "member"] },
          "membershipId": { "type": "string" },
          "joinedAt": { "type": "string", "format": "date-time" }
        }
      },
      "UpdateUserRequest": {
        "type": "object",
        "properties": {
          "email": { "type": "string", "format": "email" },
          "username": { "type": "string" }
        }
      },
      "Membership": {
        "type": "object",
        "properties": {
          "_id": { "type": "string" },
          "userId": { "type": "object" },
          "projectId": { "type": "string" },
          "role": { "type": "string", "enum": ["owner", "admin", "manager", "member"] },
          "status": { "type": "string", "enum": ["active", "pending", "suspended"] },
          "metadata": { "type": "object" },
          "invitedBy": { "type": "string" },
          "joinedAt": { "type": "string", "format": "date-time" },
          "createdAt": { "type": "string", "format": "date-time" },
          "updatedAt": { "type": "string", "format": "date-time" }
        }
      },
      "InviteMemberRequest": {
        "type": "object",
        "required": ["email"],
        "properties": {
          "email": { "type": "string", "format": "email" },
          "role": { "type": "string", "enum": ["admin", "manager", "member"], "default": "member" }
        }
      },
      "UpdateRoleRequest": {
        "type": "object",
        "required": ["role"],
        "properties": {
          "role": { "type": "string", "enum": ["admin", "manager", "member"] }
        }
      },
      "UpdateMetadataRequest": {
        "type": "object",
        "required": ["metadata"],
        "properties": {
          "metadata": {
            "type": "object",
            "properties": {
              "preferences": { "type": "object" },
              "settings": { "type": "object" }
            }
          }
        }
      }
    }
  },
  "paths": {
    "/auth/register": {
      "post": {
        "tags": ["Auth"],
        "summary": "Register a new user",
        "description": "Creates a new user and project membership. If the user already exists, joins them to the project.",
        "security": [{ "ApiKeyAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/RegisterRequest" }
            }
          }
        },
        "responses": {
          "201": {
            "description": "User registered",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "400": {
            "description": "Missing fields or already registered",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "401": {
            "description": "Invalid credentials (existing user, wrong password)",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/auth/login": {
      "post": {
        "tags": ["Auth"],
        "summary": "Login with email and password",
        "description": "Authenticates a user and returns JWT access token and refresh token. May include `passkeySetupRequired` flag if project policy is 'encouraged'.",
        "security": [{ "ApiKeyAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/LoginRequest" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Login successful",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/LoginResponse" } } }
          },
          "400": {
            "description": "Missing email or password",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "401": {
            "description": "Invalid credentials",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "403": {
            "description": "No active membership for this project",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/auth/refresh": {
      "post": {
        "tags": ["Auth"],
        "summary": "Refresh access token",
        "description": "Exchanges a valid refresh token for a new access token and refresh token pair. The old refresh token is revoked (rotation).",
        "security": [{ "ApiKeyAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/RefreshRequest" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Token refreshed",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/RefreshResponse" } } }
          },
          "400": {
            "description": "Missing refresh token",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "401": {
            "description": "Invalid or expired refresh token",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "403": {
            "description": "Membership no longer active",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/auth/logout": {
      "post": {
        "tags": ["Auth"],
        "summary": "Logout",
        "description": "Revokes the provided refresh token.",
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/LogoutRequest" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Logged out",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "400": {
            "description": "Missing refresh token",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/auth/passkey/register/options": {
      "post": {
        "tags": ["Passkey"],
        "summary": "Generate passkey registration options",
        "description": "Generates WebAuthn registration options for the authenticated user to register a new passkey. User must be logged in via password first.",
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": {
            "description": "Registration options generated",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/PasskeyRegistrationOptionsResponse" } } }
          },
          "404": {
            "description": "User not found",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/auth/passkey/register/verify": {
      "post": {
        "tags": ["Passkey"],
        "summary": "Verify passkey registration",
        "description": "Completes passkey registration by verifying the WebAuthn credential and storing it.",
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/PasskeyVerifyRegistrationRequest" }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Passkey registered",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/PasskeyVerifyRegistrationResponse" } } }
          },
          "400": {
            "description": "Missing fields, invalid challenge, or verification failed",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/auth/passkey/login/options": {
      "post": {
        "tags": ["Passkey"],
        "summary": "Generate passkey login options",
        "description": "Generates WebAuthn authentication options. Optionally provide an email to scope allowed credentials to that user.",
        "security": [{ "ApiKeyAuth": [] }],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/PasskeyLoginOptionsRequest" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Authentication options generated",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/PasskeyLoginOptionsResponse" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/auth/passkey/login/verify": {
      "post": {
        "tags": ["Passkey"],
        "summary": "Verify passkey login",
        "description": "Completes passkey authentication and returns JWT access token and refresh token (same shape as password login).",
        "security": [{ "ApiKeyAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/PasskeyVerifyLoginRequest" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Login successful",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/LoginResponse" } } }
          },
          "400": {
            "description": "Missing fields or invalid challenge",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "401": {
            "description": "Passkey not recognized or authentication failed",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "403": {
            "description": "No active membership for this project",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/auth/passkey/credentials": {
      "get": {
        "tags": ["Passkey Management"],
        "summary": "List registered passkeys",
        "description": "Returns all passkeys registered by the authenticated user.",
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": {
            "description": "Credentials list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "credentials": {
                      "type": "array",
                      "items": { "$ref": "#/components/schemas/PasskeyCredential" }
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/auth/passkey/credentials/{id}": {
      "patch": {
        "tags": ["Passkey Management"],
        "summary": "Rename a passkey",
        "description": "Updates the friendly name of a registered passkey.",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" },
            "description": "Passkey credential ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["name"],
                "properties": {
                  "name": { "type": "string", "example": "Personal Phone" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Credential updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "credential": { "$ref": "#/components/schemas/PasskeyCredential" }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Name is required",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "404": {
            "description": "Credential not found",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      },
      "delete": {
        "tags": ["Passkey Management"],
        "summary": "Delete a passkey",
        "description": "Removes a registered passkey. The user can no longer use it to log in.",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" },
            "description": "Passkey credential ID"
          }
        ],
        "responses": {
          "204": { "description": "Credential deleted" },
          "404": {
            "description": "Credential not found",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/auth/passkey/opt-out": {
      "post": {
        "tags": ["Passkey Management"],
        "summary": "Opt out of passkey enrollment",
        "description": "Marks the user as opted out of the passkey enrollment nudge for this project. The `passkeySetupRequired` flag will no longer appear in login responses.",
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": {
            "description": "Opted out",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "404": {
            "description": "Active membership not found",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/users": {
      "get": {
        "tags": ["Users"],
        "summary": "List all users in project",
        "description": "Returns all active users and their membership info for the current project.",
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": {
            "description": "User list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/User" }
                }
              }
            }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/users/{id}": {
      "get": {
        "tags": ["Users"],
        "summary": "Get user by ID",
        "description": "Returns a specific user's details within the current project. Requires Admin role or higher.",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" },
            "description": "User ID"
          }
        ],
        "responses": {
          "200": {
            "description": "User details",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/User" } } }
          },
          "404": {
            "description": "User not found in this project",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      },
      "put": {
        "tags": ["Users"],
        "summary": "Update user",
        "description": "Updates email and/or username for a user in the current project. Requires Admin role or higher.",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" },
            "description": "User ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/UpdateUserRequest" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "User updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": { "type": "string" },
                    "user": { "$ref": "#/components/schemas/User" }
                  }
                }
              }
            }
          },
          "404": {
            "description": "User not found in this project",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      },
      "delete": {
        "tags": ["Users"],
        "summary": "Remove user from project",
        "description": "Removes a user's membership from the current project. Requires Admin role or higher.",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" },
            "description": "User ID"
          }
        ],
        "responses": {
          "200": {
            "description": "User removed",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "404": {
            "description": "User not found in this project",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/memberships": {
      "get": {
        "tags": ["Memberships"],
        "summary": "List project members",
        "description": "Returns all active and pending memberships for the current project.",
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": {
            "description": "Membership list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Membership" }
                }
              }
            }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/memberships/{userId}": {
      "get": {
        "tags": ["Memberships"],
        "summary": "Get member by user ID",
        "description": "Returns membership details for a specific user in the current project.",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          {
            "name": "userId",
            "in": "path",
            "required": true,
            "schema": { "type": "string" },
            "description": "User ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Membership details",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Membership" } } }
          },
          "404": {
            "description": "Member not found",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      },
      "delete": {
        "tags": ["Memberships"],
        "summary": "Remove a member",
        "description": "Removes a member from the project. Requires Admin role or higher. Cannot remove the owner.",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          {
            "name": "userId",
            "in": "path",
            "required": true,
            "schema": { "type": "string" },
            "description": "User ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Member removed",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "403": {
            "description": "Cannot remove owner or member with equal/higher role",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "404": {
            "description": "Member not found",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/memberships/invite": {
      "post": {
        "tags": ["Memberships"],
        "summary": "Invite a member",
        "description": "Invites a user to the project by email. Creates the user if they don't exist. Requires Admin role or higher.",
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/InviteMemberRequest" }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Invitation sent",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": { "type": "string" },
                    "membership": { "$ref": "#/components/schemas/Membership" }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Missing email, user already a member, or invitation already sent",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "403": {
            "description": "Cannot assign a role equal or higher than your own",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/memberships/{userId}/role": {
      "put": {
        "tags": ["Memberships"],
        "summary": "Update member role",
        "description": "Changes a member's role. Requires Admin role or higher. Cannot modify the owner's role or assign a role equal/higher than your own.",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          {
            "name": "userId",
            "in": "path",
            "required": true,
            "schema": { "type": "string" },
            "description": "User ID"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/UpdateRoleRequest" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Role updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": { "type": "string" },
                    "membership": { "$ref": "#/components/schemas/Membership" }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Role is required",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "403": {
            "description": "Insufficient permissions",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "404": {
            "description": "Member not found",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/memberships/leave": {
      "post": {
        "tags": ["Memberships"],
        "summary": "Leave project",
        "description": "Removes the authenticated user's membership from the project. Owners must transfer ownership first.",
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": {
            "description": "Successfully left the project",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "403": {
            "description": "Owner must transfer ownership before leaving",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "404": {
            "description": "Membership not found",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/memberships/accept": {
      "post": {
        "tags": ["Memberships"],
        "summary": "Accept invitation",
        "description": "Accepts a pending project invitation for the authenticated user.",
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": {
            "description": "Invitation accepted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": { "type": "string" },
                    "membership": { "$ref": "#/components/schemas/Membership" }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Pending invitation not found",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    },
    "/memberships/metadata": {
      "put": {
        "tags": ["Memberships"],
        "summary": "Update own metadata",
        "description": "Updates the authenticated user's membership metadata (preferences, settings).",
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/UpdateMetadataRequest" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Metadata updated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": { "type": "string" },
                    "membership": { "$ref": "#/components/schemas/Membership" }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Membership not found",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          },
          "500": {
            "description": "Server error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } }
          }
        }
      }
    }
  }
}
